{% extends 'base.html' %}
{% load static %}

{% block extra_css %}

    <link rel="stylesheet" href="{% static 'css/employees.css' %}">
{% endblock %}

{% block content %}
<div class="employee-container">
    
    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div>
            <h2 style="color: var(--rank-dark-blue);"><i class="fas fa-users-cog"></i> إدارة القوى البشرية</h2>
            <p style="color: #7f8c8d; font-size: 14px;">إدارة بيانات الضباط والأفراد والحصص التموينية</p>
        </div>
        <button class="btn-primary" onclick="openCreateEmployeeModal()">
            <i class="fas fa-user-plus"></i> تسجيل موظف جديد
        </button>
    </div>

    <div class="data-card" style="padding: 20px; margin-bottom: 20px; background: #f8f9fa;">
        <form method="GET" style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 15px; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label><i class="fas fa-search"></i> بحث سريع</label>
                <input type="text" name="search" class="form-input" placeholder="الاسم أو الرقم العسكري..." value="{{ request.GET.search }}">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label><i class="fas fa-medal"></i> تصفية بالرتبة</label>
                <select name="rank" class="form-input">
                    <option value="">كل الرتب</option>
                    {% for rank in ranks %}
                        <option value="{{ rank.id }}" {% if request.GET.rank == rank.id|stringformat:"s" %}selected{% endif %}>{{ rank.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn-primary" style="height: 45px; background-color: #34495e !important;">
                تطبيق البحث
            </button>
        </form>
    </div>

    <div class="data-card">
        <table class="main-table">
            <thead>
                <tr>
                    <th>الاسم والرقم العسكري</th>
                    <th>الرتبة</th>
                    <th>الحصة الأسبوعية</th>
                    <th>الحصة الشهرية</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees %}
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="background: #eee; padding: 10px; border-radius: 50%;"><i class="fas fa-user-shield"></i></div>
                            <div>
                                <div class="emp-name">{{ emp.name }}</div>
                                <div class="emp-id">{{ emp.military_number }}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="type-badge" style="background: #f0f4f8; color: #2c3e50; border: 1px solid #d1d9e6;">{{ emp.rank.name }}</span></td>
                    <td>
                        {% if emp.weekly_quota_override %}
                            <span class="quota-badge quota-override" title="حصة مستثناة">{{ emp.weekly_quota_override }} لتر <i class="fas fa-star"></i></span>
                        {% else %}
                            <span class="quota-badge quota-default">{{ emp.rank.default_weekly_quota }} لتر</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if emp.monthly_quota_override %}
                            <span class="quota-badge quota-override" title="حصة مستثناة">{{ emp.monthly_quota_override }} لتر <i class="fas fa-star"></i></span>
                        {% else %}
                            <span class="quota-badge quota-default">{{ emp.rank.default_monthly_quota }} لتر</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if emp.is_active %}
                            <span style="color: #27ae60;"><i class="fas fa-check-circle"></i> نشط</span>
                        {% else %}
                            <span style="color: #e74c3c;"><i class="fas fa-times-circle"></i> معطل</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <a href="{% url 'employee_detail' emp.id %}" class="btn-search" style="background:#2ecc71" title="عرض التفاصيل">
                                <i class="fas fa-chart-line"></i>
                            </a>
                            <button class="btn-search" style="background:#f39c12" title="تعديل"
                                onclick="openEditEmployeeModal('{{ emp.id }}', '{{ emp.name }}', '{{ emp.military_number }}', '{{ emp.rank.id }}', '{{ emp.weekly_quota_override|default:'' }}', '{{ emp.monthly_quota_override|default:'' }}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% if emp.is_active %}
                            <form method="POST" style="display:inline;" onsubmit="return confirm('هل أنت متأكد من تعطيل هذا الموظف؟');">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="deactivate">
                                <input type="hidden" name="employee_id" value="{{ emp.id }}">
                                <button type="submit" class="btn-search" style="background:#e74c3c" title="تعطيل">
                                    <i class="fas fa-user-slash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #95a5a6;">
                        <i class="fas fa-users-slash fa-3x"></i>
                        <p style="margin-top: 10px;">لا يوجد موظفون مطابقون للبحث</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="employeeModal" class="modal">
    <div class="modal-content" style="max-width: 650px;">
        <div class="modal-header">
            <h3 id="empModalTitle"><i class="fas fa-user-edit"></i> بيانات الموظف</h3>
            <span class="close" onclick="closeModal('employeeModal')">&times;</span>
        </div>
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="action" id="empAction" value="create">
            <input type="hidden" name="employee_id" id="empId">
            
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>الاسم الرباعي</label>
                        <input type="text" name="name" id="empName" required class="form-input" placeholder="أدخل الاسم الكامل">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>الرقم العسكري</label>
                        <input type="text" name="military_number" id="empMilitaryNumber" required class="form-input" placeholder="000000">
                    </div>
                </div>

                <div class="form-group">
                    <label>الرتبة العسكرية</label>
                    <select name="rank" id="empRank" required class="form-input">
                        <option value="" disabled selected>اختر الرتبة...</option>
                        {% for rank in ranks %}
                        <option value="{{ rank.id }}">{{ rank.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="modal-section-title" style="background: #fff9e6; padding: 5px 10px; border-radius: 4px;">
                    <i class="fas fa-star" style="color: #f1c40f;"></i> استثناءات الحصص (Override)
                </div>
                <p style="font-size: 11px; color: #7f8c8d; margin-bottom: 15px;">* اترك الحقول فارغة ليتم تطبيق الحصة الافتراضية للرتبة تلقائياً.</p>

                <div class="form-row">
                    <div class="form-group">
                        <label>حصة أسبوعية خاصة (لتر)</label>
                        <input type="number" step="0.1" name="weekly_override" id="empWeekly" class="form-input" placeholder="مثلاً: 25.5">
                    </div>
                    <div class="form-group">
                        <label>حصة شهرية خاصة (لتر)</label>
                        <input type="number" step="0.1" name="monthly_override" id="empMonthly" class="form-input" placeholder="مثلاً: 100.0">
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="background: #f8f9fa;">
                <button type="submit" class="btn-save-fuel" style="width: 100%;">حفظ البيانات</button>
            </div>
        </form>
    </div>
</div>

<script>
    // دالة فتح مودال الإضافة
    function openCreateEmployeeModal() {
        document.getElementById('empModalTitle').innerHTML = '<i class="fas fa-user-plus"></i> إضافة موظف جديد';
        document.getElementById('empAction').value = 'create';
        document.getElementById('empId').value = '';
        document.getElementById('empName').value = '';
        document.getElementById('empMilitaryNumber').value = '';
        document.getElementById('empRank').value = '';
        document.getElementById('empWeekly').value = '';
        document.getElementById('empMonthly').value = '';
        document.getElementById('employeeModal').style.display = 'flex';
    }

    // دالة فتح مودال التعديل
    function openEditEmployeeModal(id, name, milNum, rankId, weekly, monthly) {
        document.getElementById('empModalTitle').innerHTML = '<i class="fas fa-user-edit"></i> تعديل بيانات: ' + name;
        document.getElementById('empAction').value = 'update';
        document.getElementById('empId').value = id;
        document.getElementById('empName').value = name;
        document.getElementById('empMilitaryNumber').value = milNum;
        document.getElementById('empRank').value = rankId;
        // معالجة القيم الفارغة لضمان عدم ظهور كلمة None
        document.getElementById('empWeekly').value = (weekly === 'None' || weekly === '') ? '' : weekly;
        document.getElementById('empMonthly').value = (monthly === 'None' || monthly === '') ? '' : monthly;
        document.getElementById('employeeModal').style.display = 'flex';
    }

    // --- الدالة المفقودة التي تسبب المشكلة ---
    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // إغلاق المودال عند النقر في أي مكان خارجه (احترافي)
    window.onclick = function(event) {
        const modal = document.getElementById('employeeModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
{% endblock %}